<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>IRC Client Demo</title>

	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/3.0.1/css/primer.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css" />-->
	<style>

		:root {
			color-scheme: light dark;

			--color-mode: 'light';
			--accent-primary: #007aff;
			--accent-secondary: #eee;
			--accent-tertiary: #c2e6c2;
			--text-color: #222;
			--background-color: #f4f4f4;
			--selection-color: #ffd86b;
		}

		@media (prefers-color-scheme: dark) {
			:root {
				--color-mode: 'dark';
			}

			:root:not([data-theme]) {
				--accent-primary: #007aff;
				--accent-secondary: #2b2925;
				--accent-tertiary: #242b24;
				--text-color: #999;
				--background-color: #161a1b;
				--selection-color: #ffd86b;
			}
		}

		* { box-sizing: border-box; }
		html {
			font: 100%/1.4 -system-ui, -apple-system, BlinkMacSystemFont, Helvetica, Arial, sans-serif;
			background-color: var(--background-color);
			-webkit-hyphens: auto;
			hyphens: auto;
		}

		ul {
			padding: 0;
			margin: 0;
		}

		li {
			list-style: none;
		}

		input {
			font-size: 1rem;
		}

		h1, h2, h3 {
			margin: 0 0 0.2em 0;
		}

		button,
		a.button,
		input[type="submit"],
		input[type="button"] {
			-webkit-appearance: none;
			appearance: none;
			border: 0;
			font-size: 1rem;
			background-color: var(--accent-primary);
			color: #fffd;
			padding: 0.2em 0.5em 0.25em;
			border-radius: 0.2em;
			cursor: pointer;
		}

		button:hover,
		a.button:hover,
		input[type="submit"]:hover,
		input[type="button"]:hover,
		button:focus,
		a.button:focus,
		input[type="submit"]:focus,
		input[type="button"]:focus {
			opacity: 0.9;
		}

		input[type="text"],
		input[type="number"] {
			font-size: 1rem;
			border: 1px solid #9999;
			background-color: transparent;
			padding: 0.15em 0.2em 0.2em;
			color: var(--text-color);
		}

		input[readonly] {
			background-color: #9993;
			color: #0005;
		}

		.hidden {
			display: none;
		}

		.icon {
			display: inline-block;
			width: 1em;
			height: 1em;
		}

		.icon.small {
			font-size: 0.8em;
		}

		.icon.close {
			background-color: currentColor;
			-webkit-mask: url('https://raw.githubusercontent.com/primer/octicons/master/icons/x-circle-16.svg') no-repeat center;
			mask: url('https://raw.githubusercontent.com/primer/octicons/master/icons/x-circle-16.svg') no-repeat center;
			-webkit-mask-size: contain;
			mask-size: contain;
		}

		.icon.close:hover {
			color: #000;
		}

		#app {
			border: 0px solid #aaa;
			background-color: #ffffff0a;
			padding: 0.5rem;
			display: grid;
			grid-template-columns: 1fr 2fr 1fr;
			/* grid-template-rows: 50px 100px; */
			grid-gap: 1rem;
			max-width: 140ch;
			margin: 1rem auto;
		}

		#main-nav {
			padding: 0 1em 1em 1em;
			padding: 0.5rem;
			grid-row: 1;
			grid-column: 1 / 2;
		}

		/*
		#connection-indicator::before {
			content: "";
			display: inline-block;
			vertical-align: middle;
			width: 0.5em;
			height: 0.5em;
			border-radius: 100%;
			background-color: rgb(255,59,48);
			margin-right: 0.5em;
		}

		#connection-indicator.on::before {
			background-color: rgb(52,199,89);
		}
		*/

		#connection-indicator .icon.dot {
			background-color: rgb(255,59,48);
			-webkit-mask: url('https://raw.githubusercontent.com/primer/octicons/master/icons/dot-16.svg') no-repeat center;
			mask: url('https://raw.githubusercontent.com/primer/octicons/master/icons/dot-16.svg') no-repeat center;
		}

		#connection-indicator .icon.dot-fill {
			background-color: rgb(52,199,89);
			-webkit-mask: url('https://raw.githubusercontent.com/primer/octicons/master/icons/dot-fill-16.svg') no-repeat center;
			mask: url('https://raw.githubusercontent.com/primer/octicons/master/icons/dot-fill-16.svg') no-repeat center;
		}

		#channels {
			border-top: 0 solid #ccc;
			padding: 0.5rem;
			grid-row: 1;
			grid-column: 2 / 3;
		}

		#channels li {
			display: inline;
			margin-right: 0.5ch;
		}

		#channels a {
			display: inline-block;
			text-decoration: none;
			color: #000;
			background-color: #ddd;
			border-radius: 0.2em;
			padding: 0.1em 0.4em 0.15em;
		}

		#channels a:hover,
		#channels a:focus {
			text-decoration: underline;
		}

		#chats {
			grid-row: 2;
			grid-column: 2 / 3;
		}

		#messages {
			border-top: 0.2rem solid #ccc;
			padding: 0.5rem;
		}

		#messages nav {
			margin-bottom: 0.5em;
		}

		#messages nav ul {
			display: flex;
			flex-wrap: wrap;
			line-height: 1.65; /* magic number to make borders align nicely */
		}

		#messages nav a {
			background: #eee;
			color: #0007;
			text-decoration: none;
			padding: 0.2em 0.5em 0.25em;
			border: 1px solid #eee;
			border-bottom: 1px solid #ccc;
		}

		#messages nav .active a {
			color: var(--text-color);
			background: transparent;
			border: 1px solid #ccc;
			border-bottom-color: transparent;
		}

		#messages .tab-content > li:not(.active) {
			display: none;
		}

		#messages .tab-content li .prefix::after {
			content: ':';
		}

		#messages .tab-content > li:not([data-title="server"]) .command,
		#messages .tab-content > li:not([data-title="server"]) .target {
			/* display: none; */
		}

		#messages .tab-content .users li {
			display: inline;
			margin-right: 0.5em;
		}

		#messages .tab-content .users li a {
			display: inline-block;
			text-decoration: none;
			color: #000;
			background-color: #ddd;
			border-radius: 0.2em;
			padding: 0.1em 0.4em 0.15em;
		}

		#messages .tab-content .users .icon.oper {
			background: url('https://raw.githubusercontent.com/primer/octicons/master/icons/verified-16.svg') no-repeat center;
			vertical-align: text-bottom;
			margin-right: 0.25em;
		}

		#messages .tab-content .messages {
			padding-top: 1rem;
			max-height: 60vh;
			overflow-y: scroll;
			overflow-x: hidden;
		}

		#messages .tab-content .messages li {
			padding: 0.1em 0;
			overflow-wrap: break-word;
			word-break: break-all; 
		}

		#messages .tab-content .messages li + li {
			border-top: 1px solid #eee;
		}

		#messages .tab-content .messages li.error {
			background: red;
			border-top-color: #ccc;
		}

		#messages .tab-content .messages li.self {
			/* chat message you sent */
			color: var(--accent-primary);
		}

		#messages .tab-content .messages li.mention {
			/* chat message that mentions your nickname */
			background: #4396f13b;
			color: #fff;
		}

		#messages .tab-content .messages li.pm {
			/* chat message by a normal user */
		}

		#messages .tab-content .messages li span,
		#messages .tab-content .messages li time {
			
		}

		#messages .tab-content .messages li time {
			
		}

		#input {
			border-top: 1px solid #ccc;
			padding: 0.5rem;
			display: flex;
		}

		#input input[type="text"],
		#input textarea { flex: 1; }
		#input input[type="submit"] { flex: 0 0 8ch; margin-left: 1em; }

		#userdata {
			border-top: 0.2rem solid #ccc;
			padding: 0.5rem;
			grid-row: 2;
			grid-column: 1 / 2;
		}

		#userdata form label {
			display: inline-block;
			
			margin-right: 0.5em;
		}

		#userdata form p.input {
			display: flex;
		}

		#userdata form p.input label {
			flex-basis: 14ch;
			-webkit-hyphens: none;
			hyphens: none;
		}

		#userdata form p.input input[type="text"],
		#userdata form p.input input[type="number"] {
			flex: 1;
			border: 0;
			border-bottom: 1px solid #9993;
		}

		#help {
			border-top: 0.2rem solid #ccc;
			padding: 0.5rem;
			grid-row: 2;
			grid-column: 3 / 4;

			display: none;
		}

		#dm {
			border-top: 0.2rem solid #ccc;
			padding: 0.5rem;
			grid-row: 2;
			grid-column: 3 / 4;
		}

		#dm .conversations > li {
			padding: 0.2em 0 0.25em 0;
		}

		#dm .conversations > li + li {
			border-top: 1px solid #ccc;
		}

		#dm .conversations h2 {
			font-size: 1rem;
		}

		#dm .conversations a {
			color: currentColor;
			text-decoration: none;
		}

		#dm .icon.discussion {
			background: url('https://raw.githubusercontent.com/primer/octicons/master/icons/comment-discussion-16.svg') no-repeat center;
			vertical-align: middle;
		}

		#dm .conversations .messages li {
			font-size: 0.875em;
			padding: 0.2em 0.45em 0.3em;
			border-radius: 0.4em;
			background-color: #ddd;
			color: #000;
			margin-bottom: 0.25em;
			width: 80%;
		}

		#dm .conversations .messages li.self {
			background-color: #007aff;
			color: #fff;
			margin-left: 20%;
		}

		#dm .conversations .messages li.them {
			
		}

		#dm .conversations .messages time,
		#dm .conversations .messages .prefix,
		#dm .conversations .messages .command,
		#dm .conversations .messages .target {
			display: none;
		}

		#dm .conversations .messages .prefix::after {
			content: ':';
		}

		#dm .conversations .messages,
		#dm .conversations .input {
			display: none;
		}

		#dm .conversations li.active .messages {
			display: block;
		}

		#dm .conversations li.active .input {
			display: flex;
		}

		#dm .conversations li.active .input input[type="text"] { flex: 1; }
		#dm .conversations li.active .input input[type="submit"] { flex: 0; }

		#dm .unread-count {
			display: inline-block;
			font-size: 0.75em;
			background: red;
			color: #fff;
			padding: 0 0.3em;
			border-radius: 0.4em;
		}
	</style>

	
</head>
<body>

	<div id="app">
		<nav id="main-nav">
			<span id="connection-indicator" v-bind:class="connected ? 'on' : 'off'">
				<span v-if="!connected" class="icon dot small"></span>
				<span v-if="connected" class="icon dot-fill small"></span> {{ connected ? 'Connected' : 'Disconnected' }}</span> <button class="primary" v-on:click.prevent="toggleConnection">{{ connected ? 'Disconnect' : 'Connect' }}</button>
		</nav>
		<div id="channels">
			<h2>Available Channels</h2>
			<ul>
				<li v-if="channels.length < 1">No active channels</li>
				<li v-for="channel in channels">
					<a v-bind:href="channel" v-on:click.prevent="join($event,channel)">{{ channel }}</a>
				</li>
			</ul>
		</div>
		<div id="chats">
			<div id="messages">
				<h2>Connected channels</h2>
				<nav class="tab-navigation">
					<ul>
						<li v-for="tab in tabs" v-bind:class="(tab.active) ? 'active' : ''">
							<a v-bind:href="tab.title" v-on:click.prevent="activate(tab.title)">{{ tab.title }}&nbsp;<span v-if="tab.title != 'server'" href="#close" v-on:click.prevent="closeTab(tab.title)" class="icon close small"></span></a> 
							
						</li>
					</ul>
				</nav>
				<ul class="tab-content">
					<li v-for="tab in tabs" v-bind:data-title="tab.title" v-bind:class="(tab.active) ? 'active' : ''">
						<ul class="users">
							<li v-for="user in tab.users"><a href="#dm" v-on:click.prevent="newDM(user)"><span v-if="user.startsWith('@')" class="icon oper"></span>{{ user.replace('@', '') }}</a></li>
						</ul>
						<ul class="messages">
							<li v-for="msg in tab.messages" v-bind:class="[(msg.command == 'ERROR') ? 'error' : '', msgType(msg)]">
								<time v-bind:datetime="formatDatetime(msg.tags.time)">{{ formatDatetime(msg.tags.time, 'short') }}</time>
								<span class="prefix">{{ !msg.prefix.isServer ? msg.prefix.nick : msg.prefix.host }}</span>
								<span class="command" v-bind:title="msg.commandString ? msg.commandString : ''" v-bind:class="(tab.title != 'server' && msg.command.toUpperCase() == 'PRIVMSG') ? 'hidden' : ''">{{ msg.command }}</span>
								<span class="target" v-bind:class="(tab.title != 'server' && msg.command.toUpperCase() == 'PRIVMSG') ? 'hidden' : ''">{{ msg.params[0] }}</span>
								<span class="params">{{ msg.params[1] }}</span>
							</li>
						</ul>
					</li>
				</ul>
			</div>
			<form id="input">
				<input type="text" id="msg" placeholder="your message" autocomplete="off" />
				<input type="submit" value="Send" />
			</form>
		</div>
		<div id="userdata">
			<h2>User data</h2>
			<form>
				<p class="input"><label for="user-name">username</label><input type="text" id="user-name" placeholder="your username" v-bind:value="username" v-bind:readonly="connectionLock" required /></p>
				<p class="input"><label for="user-realname">real name</label><input type="text" id="user-realname" placeholder="your real name" v-bind:value="realname" v-bind:readonly="connectionLock" required /></p>
				<p class="input"><label for="user-nick">nickname</label><input type="text" id="user-nick" placeholder="your nickname" v-bind:value="nick" required /></p>
				<p class="input"><input type="submit" value="Save" v-on:click.prevent="save" /></p>
				<p>Please note: For changes to username or real name to happen, you need to disconnect from the IRC server.</p>

				<p class="input"><label for="server-url">Server URL</label><input type="text" id="server-url" placeholder="irc.unrealircd.org" v-model="serverurl" v-bind:readonly="connectionLock" required /></p>
				<p class="input"><label for="server-port">Websocket Port</label><input type="number" id="server-port" placeholder="443" v-model="serverport" v-bind:readonly="connectionLock" required /></p>
			</form>
		</div>
		<div id="help">
			<h2>Commands</h2>
			
			<ul>
				<li>/JOIN #&lt;channel&gt;</li>
				<li>/PART #&lt;channel&gt;</li>
				<li>/MSG &lt;target&gt; :message</li>
				<li>/NICK &lt;nickname&gt;</li>
				<li>/WHOIS &lt;nickname&gt;</li>
				<li>/MODE #&lt;channel&gt; +o &lt;nickname&gt;</li>
			</ul>

			<p><a href="https://gist.github.com/xero/2d6e4b061b4ecbeb9f99">Detailed help</a></p>
		</div>
		<div id="dm">
			<h2>Direct Messages <span class="unread-count" v-if="unreadMessages > 0">{{ unreadMessages }}</span></h2>
			<!-- direct messages -->
			<ul class="conversations">
				<li v-for="conv in conversations" v-bind:class="(conv.active) ? 'active' : ''" v-bind:id="'dm-'+conv.title">
					<h2><span class="icon discussion"></span> <a v-bind:href="conv.title" v-on:click.prevent="showConversation(conv.title)">{{ conv.title }} <span class="unread-count" v-if="conv.unread > 0">{{ conv.unread }}</span></a></h2>

					<ul class="messages">
						<li v-for="msg in conv.messages" v-bind:class="(msg.prefix.nick !== conv.title) ? 'self' : 'them'" v-bind:title="formatDatetime(msg.tags.time, 'short')">
							<time v-bind:datetime="formatDatetime(msg.tags.time)">{{ formatDatetime(msg.tags.time, 'short') }}</time>
							<span class="prefix">{{ msg.prefix.nick }}</span>
							<span class="command">{{ msg.command }}</span>
							<span class="target">{{ msg.params[0] }}</span>
							<span class="params">{{ msg.params[1] }}</span>
						</li>
					</ul>

					<form class="input" v-bind:id="'dm-'+conv.title+'-input'" v-on:submit.prevent="sendDM(conv.title, conv.input, $event)">
						<input type="text" id="msg" placeholder="your message" autocomplete="off" v-model="conv.input" v-bind:maxlength="512 - conv.title.length - 'PRIVMSG'.length - 2" />
						<input type="submit" value="Send" />
					</form>
				</li>
			</ul>
		</div>
	</div>

	<script type="module">
		import Vue from './vue.esm.browser.js'; // replace with vue.esm.browser.min.js for production
		import { Parser } from './parser.js';

		const app = {
			'parser': new Parser(),
			'inputLog': [],
			'messageLog': [],
			'autoJoin': ['#html', '#int'],
			'sendMessage': function (text, channel) {

				if (text.startsWith('/') || !channel) {
					app.connection.ws.send(text.substring(1)+"\r\n");
				} else {
					channel = (channel.startsWith('#')) ? channel : '#'+channel;
					app.connection.ws.send('PRIVMSG '+channel+' :'+text+"\r\n");

					const tab = app.messageWindow.get(channel);
					if (!tab) {
						console.error('You can\'t talk here, you need to join a channel first!');
						return;
					}
					
					// app.messageWindow.addMessage(text, channel); // obsolete as per echo-message
				}
			},
			'formatDatetime': function (ts, mode) {
				/* via https://gist.github.com/kmaida/6045266 */

				if (!ts) ts = Date.now();

				const d = new Date(ts);
				const yyyy = d.getFullYear();
				const mm = (d.getMonth() + 1).toString().padStart(2, '0');
				const dd = d.getDate().toString().padStart(2, '0');
				const hh = d.getHours().toString().padStart(2, '0');
				const min = d.getMinutes().toString().padStart(2, '0');
				const sec = d.getSeconds().toString().padStart(2, '0');

				const time = yyyy + '-' + mm + '-' + dd + ' ' + hh + ':' + min + ':' + sec;
				const shorttime = hh + ':' + min;

				return (mode && mode == 'short') ? shorttime : time;
			}
		};

		app.server = {
			'protocol': 'wss',
			'url': 'irc.arnorichter.de',
			'port': 47363
		}

		const seed = Math.floor(Math.random()*100000+1);
		app.user = new Vue({
			'el': '#userdata',
			'data': {
				'username': 'guest_'+seed,
				'nick': 'guest_'+seed,
				'realname': 'Unknown',
				'connectionLock': false,
				'serverurl': 'irc.arnorichter.de',
				'serverport': 47363
			},
			'created': function () {
				const userString = localStorage.getItem('user');
				if (userString) {					
					const user = JSON.parse(userString);

					this.username = user.username;
					this.realname = user.realname;
					this.nick = user.nickname;
				}
			},
			'methods': {
				'save': function () {
					const data = {
						'username': document.querySelector('#user-name').value,
						'realname': document.querySelector('#user-realname').value,
						'nickname': document.querySelector('#user-nick').value
					}

					this.username = data.username;
					this.realname = data.realname;
					this.nick = data.nickname;

					localStorage.setItem('user', JSON.stringify(data));

					if (app.mainNavigation.connected) {
						app.connection.ws.send('NICK '+this.nick);
					}
				}
			}
		});

		app.channelList = new Vue({
			'el': '#channels',
			'data': {
				'channels': []
			},
			'methods': {
				'join': function (e, channel) {

					if (app.connection.ws === null) return;

					console.log('joining channel', channel);
					app.connection.ws.send('JOIN '+channel);

					// add UI element tab for the channel
					app.messageWindow.addTab(channel);
				},
				'regenerate': function () {
					app.connection.ws.send('LIST');
				},
				'clear': function () {
					this.channels = [];
				}
			}
		});

		app.dm = new Vue({
			'el': '#dm',
			'data': {
				'history': 6,
				'conversations': []
			},
			'computed': {
				'getActive': function () {
					return this.conversations.find(conv => conv.active === true);
				},
				'unreadMessages': function () {
					const reducer = (unread, currentValue) => unread + currentValue.unread;
					const unread = this.conversations.reduce(reducer, 0);
					return unread;
				}
			},
			'methods': {
				'newConversation': function (user) {
					if (user.startsWith('@')) user = user.substring(1);

					for (const c of this.conversations) {
						c.active = false;
					}

					let conv = this.get(user);
					if (!conv) {
						// create a new conversation
						const newConv = {
							'title': user,
							'active': true,
							'messages': [],
							'unread': 0
						};
						this.conversations.unshift(newConv);
					} else {
						// simply bring the conversation to the foreground
						conv.active = true;
						conv.unread = 0;
					}
				},
				'showConversation': function (user) {
					if (user.startsWith('@')) user = user.substring(1);

					let conv = this.get(user);
					if (conv && conv.active == false) {
						for (const c of this.conversations) {
							c.active = false;
						}
						conv.active = true;
						conv.unread = 0;
					} else if (conv && conv.active == true) {
						// toggle
						conv.active = false;
					}
				},
				'addMessage': function (user, msg) {
					if (user.startsWith('@')) user = user.substring(1);

					let conv = this.get(user);
					if (!conv) {
						// create a new conversation
						const newConv = {
							'title': user,
							'active': false,
							'messages': [],
							'unread': 0
						};
						this.conversations.unshift(newConv);
						conv = newConv;
					}

					conv.messages.push(msg);
					if (conv.messages.length > this.history) {
						conv.messages.shift();
					}

					if (msg.prefix.nick == user && !conv.active) {
						conv.unread += 1;
					}

					// trigger event
					const customEvent = new Event('newDM');
					this.$el.dispatchEvent(customEvent);
				},
				'get': function (user) {
					if (user.startsWith('@')) user = user.substring(1);

					return this.conversations.find(tab => tab.title === user);
				},
				'sendDM': function (user, text, event) {
					if (!app.mainNavigation.connected) {
						console.error('You are not connected to a server!');
						return;
					}
					if (user.startsWith('@')) user = user.substring(1);

					console.info('sending DM to user ', user, text);
					if (text.startsWith('/') || user.length < 1) return;
					const messageString = 'PRIVMSG '+user+' :'+text;
					app.connection.ws.send(messageString);

					const conv = this.get(user);
					if (conv) {
						conv.input = '';
						if (event) {
							event.target.querySelector('input[type="text"]').focus();
						}
					}
				},
				'formatDatetime': app.formatDatetime
				/*
				,'getActive2': function () {
					const activeConversations = this.conversations.find(conv => conv.active === true);
					console.warn('act', activeConversations);
					return activeConversations ? activeConversations : [];
				}
				*/
			}
		});

		app.messageWindow = new Vue({
			'el': '#messages',
			'data': {
				'tabs': []
			},
			'computed': {
				'activeTab': function () {
					return this.tabs.find(tab => tab.active === true);
				}
			},
			'created': function () {
				const serverTab = {
					'title': 'server',
					'active': true,
					'messages': [],
					'users': []
				};
				this.tabs.push(serverTab);
			},
			'updated': function () {
				if (!this.activeTab) return;

				const msgList = this.$el.querySelector('[data-title="'+this.activeTab.title+'"] .messages');

				msgList.scrollTop = msgList.clientHeight;
			},
			'methods': {
				'get': function (title) {
					const tab = this.tabs.find(o => o.title === title);

					return (tab) ? tab : false;
				},
				'activate': function (title) {
					if (!this.get(title)) return false;

					for (const tab of app.messageWindow.tabs) {
						if (tab.title == title) {
							tab.active = true;
						} else {
							tab.active = false;
						}
					}
				},
				'addTab': function (channel, activate=true) {
					const exists = this.tabs.find(o => o.title === channel);
					if (exists) {
						this.activate(channel);
					} else {
						const newTab = {
							'title': channel,
							'active': false,
							'messages': [],
							'users': []
						};
						this.tabs.push(newTab);
						if (activate) this.activate(newTab.title);

						/*
						this.addRawCommand(':'+app.user.nick+'!'+app.user.username+'@127.0.0.1 STATUS '+channel+' :joined the channel');
						*/
					}
				},
				'closeTab': function (channel) {
					app.connection.ws.send('PART '+channel);
				},
				'removeTab': function (channel) {
					const index = this.tabs.findIndex(o => o.title === channel);

					if (index > -1) {
						this.tabs.splice(index, 1);
					}

					// set a new active tab
					const lastTab = this.tabs[this.tabs.length-1];
					this.activate(lastTab.title);
				},
				'formatDatetime': app.formatDatetime,
				'msgType': function (message) {
					// console.log('msg type', message);
					if (message.prefix) {
					// console.error(message, message.prefix.nick,'@'+app.user.nick);
					}

					if (message.prefix && !message.prefix.isServer && (message.prefix.nick == app.user.nick || message.prefix.nick == '@'+app.user.nick)) {
						// this is a normal PRIVMSG sent by you
						return 'self';
					}

					const addressedToYou = new RegExp('@'+app.user.nick + '\\b');
					if (addressedToYou.test(message.params.join(' '))) {
						// this is a PRIVMSG mentioning you
						return 'mention';
					}

					if (message.command && message.command.toUpperCase() == 'PRIVMSG') {
						// this is a PRIVMSG
						return 'pm';
					}

					return '';
				},
				'addMessage': function (text, channel) {
					if (!text || !channel) return;

					const command = ':'+app.user.nick+'!'+app.user.username+'@127.0.0.1 PRIVMSG '+channel+' :'+text;
					this.addRawCommand(command);
				},
				'addRawCommand': function (str) {
					if (!str) return;

					const customEvent = new Event('customCommand');
					customEvent.data = str+"\r\n";

					app.connection.onMessage(customEvent);
				},
				'newDM': function (user) {
					if (user.startsWith('@')) user = user.substring(1);

					if (user == app.user.nick) return; // this is you, dummy!

					app.dm.newConversation(user);
				}
			}
		});

		app.connection = new Vue({
			'data': {
				'ws': null
			},
			'methods': {
				'connect': function () {
					const conn = 'wss://'+app.user.serverurl+':'+app.user.serverport;
					this.ws = new WebSocket('wss://'+app.user.serverurl+':'+app.user.serverport);

					console.log('connecting to', conn);

					this.ws.onopen = this.onOpen;
					this.ws.onerror = this.onError;
					this.ws.onclose = this.onClose; 
					this.ws.onmessage = this.onMessage;
				},
				'disconnect': function () {
					// app.sendMessage('/QUIT');
					this.ws.send('QUIT');
					// if the QUIT command works, no need to manually call close
					// this.ws.close();
				},
				'onOpen': function (event) {
					console.log('INFO: Socket Opened');
					app.mainNavigation.connected = true;
					app.user.connectionLock = true; // prevent changes to user data

					this.ws.send('CAP LS 302');
					this.ws.send('NICK '+app.user.nick);
					this.ws.send('USER '+app.user.username+' 0 * :'+app.user.realname);
					
					// todo: do these as a reply to the list sent by the server
					// https://unitedchat.org/ircv3
					this.ws.send('CAP REQ :message-tags');
					this.ws.send('CAP REQ :server-time');
					this.ws.send('CAP REQ :echo-message');
					this.ws.send('CAP END');
				},
				'onError': function (error) {
					console.log('ERR: ', error);

					// todo: handle NICKNAMEISINUSE!
				},
				'onClose': function (event) {
					console.log('INFO: Socket Closed');

					this.ws.onopen = function () {};
					this.ws.onerror = function () {};
					this.ws.onclose = function () {};
					this.ws.onmessage = function () {};

					this.ws = null;
					app.mainNavigation.connected = false;
					app.user.connectionLock = false;

					const openChannels = app.messageWindow.tabs.map(function (a) {
						return a.title;
					});

					for (const channel of openChannels) {
						// app.messageWindow.addMessage('closed the connection.', channel);
						app.messageWindow.addRawCommand(':'+app.user.nick+'!'+app.user.username+'@127.0.0.1 STATUS '+channel+' :closed the connection.');
					}
				},
				'onMessage': function (event) {
					// console.log('RECV: ', event.data, event);

					const data = (event.detail) ? event.detail : event.data;

					app.messageLog.push(data);
					const msg = app.parser.parse(data);

					// this can be overridden to display a message in a different tab
					let targetTab = 'server';

					console.info('cmd', msg.command, msg);

					// handle ping/pong
					if (msg.command && msg.command.toUpperCase() == 'PING') {
						const messageParts = data.split(' ');
						// console.log('replying with:', 'PONG '+messageParts[1]);
						this.ws.send('PONG '+messageParts[1]);
						return;
					}

					if (msg.prefix.isServer && msg.prefix.host == app.server.url) {
						//console.warn('server message:', event.data);
					}

					if (msg.command == '376' || msg.command == '422') {
						// message of the day, request initial LIST
						this.ws.send('LIST');

						// auto-join channels, if specified
						if (app.autoJoin.length > 0) {
							this.ws.send('JOIN '+app.autoJoin.join(','));
						}
					}

					if (msg.command == '321') {
						// list items ("channels"), begin list
						app.channelList.clear();
					}

					if (msg.command == '322') {
						// list items ("channels"), add to list
						console.warn('add channel to list', msg.params);
						app.channelList.channels.push(msg.params[1]);
					}

					if (msg.command == '323') {
						// sort channel display after building list
						if (app.channelList.channels.length > 0) {
							app.channelList.channels.sort();
						}
					}

					if (msg.command == '353') {
						// list users in a channel when joining
						
						const users = msg.params[3].split(' ');
						users.sort();
						console.info('users in channel', msg.params[2], users);

						const tab = app.messageWindow.get(msg.params[2]);
						if (tab.title != 'server') {
							tab.users = users;
						}

						if (users.length > 0) {
							/*
							app.messageWindow.addMessage('Users in this channel are: '+users.join(', '), tab.title);
							*/
						} else {
							app.messageWindow.addMessage('No active users in this channel', tab.title);
						}
					}

					if (msg.command == 'JOIN') {
						
						// join a new channel
						const tab = app.messageWindow.get(msg.params[0]);
						if (tab) {
							if (msg.prefix.nick == app.user.nick) {
								// you joined a channel
								app.messageWindow.activate(msg.params[0]);
							} else {
								// somebody else joined a channel
								if(tab.users.indexOf(msg.prefix.nick) === -1) {
									tab.users.push(msg.prefix.nick);
								}
							}
						} else {
							console.info('created new tab for', msg.params[0]);
							app.messageWindow.addTab(msg.params[0], true);
						}

						// update the list as well
						if (msg.prefix.nick == app.user.nick) {
							if (!app.channelList.channels.includes(msg.params[0])) {
								app.channelList.channels.push(msg.params[0]);
								app.channelList.channels.sort();
							}
						}
					}

					if (msg.command == 'PART') {
						// part a channel
						if (msg.prefix.nick == app.user.nick) {
							// you left the channel, close tab
							app.messageWindow.removeTab(msg.params[0]);
						} else {
							// somebody else left the channel
							const tab = app.messageWindow.get(msg.params[0]);
							const index = tab.users.indexOf(msg.prefix.nick);
							tab.users.splice(index, 1);
							tab.users.sort();
						}
					}

					// todo: react to nick changes: update UI across tabs and DMs
					if (msg.command == 'NICK') {
						console.warn(msg.prefix.nick, 'changed their nick to', msg.params[0]);
					}

					// handle QUIT, eg part from all channels correctly
					// todo: maybe notify user with open DMs?
					if (msg.command == 'QUIT') {
						if (msg.prefix.nick != app.user.nick) {

							// remove user from all message tabs
							for (const tab of app.messageWindow.tabs) {
								const pos = tab.users.indexOf(msg.prefix.nick);
								if (pos !== -1) {
									tab.users.splice(pos, 1);
								}
							}
							console.info(msg.prefix.nick, 'logged off.');
						}
					}

					// direct messages eg. PRIVMSG to a single user
					if (msg.command == 'PRIVMSG' && msg.params.length > 0 && !msg.params[0].startsWith('#')) {
						console.info('received a DM from', msg.prefix.nick, 'to', msg.params[0]);
						if (msg.params[0] == app.user.nick) {
							// this is a message TO you
							app.dm.addMessage(msg.prefix.nick, msg);
						} else if (msg.prefix.nick == app.user.nick) {
							// this is a message BY you
							app.dm.addMessage(msg.params[0], msg);
						}
						return;
					}

					// channel privmsg etc
					if (msg.params.length > 0 && msg.params[0].startsWith('#')) {
						targetTab = msg.params[0];	
					}

					let target = app.messageWindow.get(targetTab);
					if (!target) target = app.messageWindow.get('server'); // fallback in case the tab no longer exists
					target.messages.push(msg);
				}
			}
		});

		app.mainNavigation = new Vue({
			'el': '#main-nav',
			'data': {
				'connected': false
			},
			'methods': {
				'toggleConnection': function () {
					if (app.connection.ws === null) {
						app.connection.connect();
					} else {
						app.connection.disconnect();
					}
				}
			}
		});

		document.querySelector('#input').addEventListener('submit', function (e) {
			e.preventDefault();
			const msgField = document.querySelector('#msg');

			// add to input log for recent messages functionality
			app.inputLog.unshift(msgField.value);
			if (app.inputLog.length > 4) { app.inputLog.slice(0,4); }

			// parse the input
			const parsed = app.parser.parse(msgField.value);
			if (parsed.command.startsWith('/')) {
				parsed.command = parsed.command.substring(1).toUpperCase();
			}
			console.log('parsed input', parsed);

			// todo: react to UI changes here?

			const activeTab = app.messageWindow.activeTab.title;

			// smart NAMES command in channels
			if (parsed.command == 'NAMES' && activeTab !== 'server') {
				msgField.value = '/'+parsed.command+' '+activeTab;
			}

			// direct message shorthand with /w
			if (parsed.command.toUpperCase() == 'W' && parsed.params[0].startsWith('@')) {
				const recipient = parsed.params[0].substring(1);
				const message = parsed.params.slice(1).join(' ');
				msgField.value = '/PRIVMSG '+recipient+' '+message;
			}

			app.sendMessage(msgField.value, (activeTab == 'server') ? '' : activeTab);
			msgField.value = '';
		});

		document.querySelector('#input').addEventListener('keyup', function (e) {
			// keyboard input history!

			const inputField = this.querySelector('#msg');

			if (e.keyCode == 38) { // up arrow
				if (app.inputLog.length > 0) {
					let logPos = inputField.getAttribute('log-position');
					if (logPos) {
						logPos = parseInt(logPos);

						logPos++;

						if (!app.inputLog[logPos]) return;
						
						inputField.value = app.inputLog[logPos];
						inputField.setAttribute('log-position', logPos);
					} else {
						inputField.value = app.inputLog[0];
						inputField.setAttribute('log-position', 0);
					}
				}
			}

			if (e.keyCode == 40) { // down arrow
				if (app.inputLog.length > 0) {
					let logPos = inputField.getAttribute('log-position');
					if (logPos) {
						logPos = parseInt(logPos);

						if (logPos === 0) {
							inputField.value = '';
							inputField.setAttribute('log-position', '');
							return;
						}

						logPos--;

						if (!app.inputLog[logPos]) return;
						
						inputField.value = app.inputLog[logPos];
						inputField.setAttribute('log-position', logPos);
					}
				}
			}
		});

		window.addEventListener('beforeunload', function (event) {
			app.connection.disconnect();
		});
	</script>

</body>
</html>